<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå‹•äº¤æ˜“æ§åˆ¶å°</title>
    <link rel="stylesheet" href="/static/css/dashboard.css">
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š è‡ªå‹•äº¤æ˜“æ§åˆ¶å°</h1>
        
        <div class="auth-section">
            <label for="authKey">API é©—è­‰é‡‘é‘°</label>
            <input type="password" id="authKey" placeholder="è«‹è¼¸å…¥é©—è­‰é‡‘é‘°">
            <label class="simulation-toggle">
                <input type="checkbox" id="simulationMode" checked>
                <span>æ¨¡æ“¬æ¨¡å¼</span>
            </label>
            <button class="btn-primary" onclick="loadCurrentTab()">è¼‰å…¥è³‡æ–™</button>
            <button class="btn-secondary" onclick="exportCSV()">åŒ¯å‡º CSV</button>
        </div>
        
        <div class="error-msg" id="errorMsg"></div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('orders')">ğŸ“‹ å§”è¨—ç´€éŒ„</button>
            <button class="tab" onclick="switchTab('positions')">ğŸ’¼ ç›®å‰æŒå€‰</button>
            <button class="tab" onclick="switchTab('symbols')">ğŸ“œ å¯ç”¨å•†å“</button>
            <button class="tab" onclick="switchTab('webhook')">ğŸ”— TradingView è¨­å®š</button>
        </div>
        
        <!-- Orders Tab -->
        <div id="orders-tab" class="tab-content active">
            <div class="filters">
                <select id="filterStatus">
                    <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                    <option value="success">æˆåŠŸ</option>
                    <option value="failed">å¤±æ•—</option>
                    <option value="no_action">ç„¡å‹•ä½œ</option>
                </select>
                <select id="filterAction">
                    <option value="">å…¨éƒ¨å‹•ä½œ</option>
                    <option value="long_entry">åšå¤šé€²å ´</option>
                    <option value="long_exit">åšå¤šå‡ºå ´</option>
                    <option value="short_entry">åšç©ºé€²å ´</option>
                    <option value="short_exit">åšç©ºå‡ºå ´</option>
                </select>
                <input type="text" id="filterSymbol" placeholder="å•†å“ä»£ç¢¼...">
                <button class="btn-secondary" onclick="fetchOrders()">å¥—ç”¨ç¯©é¸</button>
            </div>
            
            <div class="stats" id="orderStats">
                <div class="stat-card total"><h3>ç¸½å§”è¨—æ•¸</h3><div class="value" id="statTotal">-</div></div>
                <div class="stat-card success"><h3>æˆåŠŸ</h3><div class="value" id="statSuccess">-</div></div>
                <div class="stat-card failed"><h3>å¤±æ•—</h3><div class="value" id="statFailed">-</div></div>
            </div>
            
            <div id="ordersTable"><div class="empty">è«‹è¼¸å…¥é©—è­‰é‡‘é‘°ä¸¦é»æ“Šã€Œè¼‰å…¥è³‡æ–™ã€æŸ¥çœ‹å§”è¨—ç´€éŒ„</div></div>
        </div>
        
        <!-- Positions Tab -->
        <div id="positions-tab" class="tab-content">
            <div class="stats" id="positionStats">
                <div class="stat-card total"><h3>æŒå€‰æ•¸é‡</h3><div class="value" id="posCount">-</div></div>
                <div class="stat-card" id="pnlCard"><h3>æœªå¯¦ç¾æç›Š</h3><div class="value" id="totalPnl">-</div></div>
            </div>
            
            <div id="positionsTable"><div class="empty">è«‹è¼¸å…¥é©—è­‰é‡‘é‘°ä¸¦é»æ“Šã€Œè¼‰å…¥è³‡æ–™ã€æŸ¥çœ‹ç›®å‰æŒå€‰</div></div>
        </div>
        
        <!-- Symbols Tab -->
        <div id="symbols-tab" class="tab-content">
            <div class="info-card">
                <h2>ğŸ“œ å¯ç”¨äº¤æ˜“å•†å“</h2>
                <p style="color: #a1a1aa; margin-top: 0.5rem;">ä»¥ä¸‹ç‚ºç›®å‰å¯äº¤æ˜“çš„æœŸè²¨å•†å“ã€‚<strong style="color: #00d9ff;">è«‹ä½¿ç”¨ Symbol æ¬„ä½</strong>è¨­å®š TradingView è­¦å ±ã€‚</p>
                <div class="alert alert-info" style="margin-top: 1rem;">
                    ğŸ’¡ <strong>Symbol</strong> (å¦‚ MXF202601) æ˜¯ Shioaji API ä½¿ç”¨çš„æ ¼å¼ï¼›<strong>Code</strong> (å¦‚ MXFA6) æ˜¯äº¤æ˜“æ‰€ä»£ç¢¼ï¼Œåƒ…ä¾›åƒè€ƒã€‚
                </div>
            </div>
            
            <div class="filters">
                <input type="text" id="symbolSearch" placeholder="æœå°‹å•†å“ä»£ç¢¼..." oninput="filterSymbols()">
                <button class="btn-primary" onclick="fetchSymbols()">é‡æ–°è¼‰å…¥</button>
            </div>
            
            <div class="stats" id="symbolStats">
                <div class="stat-card total"><h3>å•†å“ç¸½æ•¸</h3><div class="value" id="symbolCount">-</div></div>
            </div>
            
            <div id="symbolsTable"><div class="loading">è¼‰å…¥ä¸­...</div></div>
        </div>
        
        <!-- Webhook Tab -->
        <div id="webhook-tab" class="tab-content">
            <div class="info-card">
                <h2>ğŸ”— TradingView Webhook è¨­å®šæŒ‡å—</h2>
                <p style="color: #a1a1aa; margin-top: 0.5rem;">æ­¤å¾Œç«¯ç³»çµ±å°ˆç‚º TradingView è­¦å ± Webhook è¨­è¨ˆï¼Œå¯è‡ªå‹•åŸ·è¡ŒæœŸè²¨äº¤æ˜“ã€‚</p>
            </div>
            
            <div class="info-card" id="webhookCard">
                <h3>ğŸ“ æ­¥é©Ÿä¸€ï¼šWebhook ç¶²å€</h3>
                <p style="color: #a1a1aa; margin: 0.5rem 0;">å°‡ä»¥ä¸‹ç¶²å€è²¼åˆ° TradingView è­¦å ±çš„ Webhook URL æ¬„ä½ï¼š</p>
                
                <!-- Mode Toggle Switch -->
                <div style="display: flex; align-items: center; gap: 1rem; margin: 1rem 0;">
                    <span id="simLabel" style="color: #22c55e; font-weight: 600;">ğŸ§ª æ¨¡æ“¬æ¨¡å¼</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="modeToggle" onchange="toggleTradingMode()">
                        <span class="toggle-slider"></span>
                    </label>
                    <span id="realLabel" style="color: #71717a;">ğŸ’° å¯¦ç›¤æ¨¡å¼</span>
                </div>
                
                <div class="code-block" id="webhookCodeBlock">
                    <button class="copy-btn" onclick="copyWebhookUrl()">è¤‡è£½</button>
                    <pre id="webhookUrl"></pre>
                </div>
                
                <!-- Real Trading Warning (hidden by default) -->
                <div class="alert" id="realTradingWarning" style="display: none; margin-top: 1rem; background: rgba(220, 38, 38, 0.15); border: 1px solid rgba(220, 38, 38, 0.4); color: #fca5a5;">
                    âš ï¸ <strong>å¯¦ç›¤æ¨¡å¼</strong> â€” æ­¤ç¶²å€å°‡åŸ·è¡ŒçœŸå¯¦äº¤æ˜“ï¼Œè«‹ç¢ºèªå·²è¨­å®š CA æ†‘è­‰ã€‚
                </div>
                
                <!-- Simulation Mode Info -->
                <div class="alert alert-info" id="simModeInfo" style="margin-top: 1rem;">
                    âœ… <strong>æ¨¡æ“¬æ¨¡å¼ï¼š</strong>å®‰å…¨æ¸¬è©¦ç’°å¢ƒï¼Œä¸æœƒåŸ·è¡ŒçœŸå¯¦äº¤æ˜“ã€‚
                </div>
            </div>
            
            <div class="info-card">
                <h3>ğŸ“ æ­¥é©ŸäºŒï¼šè¨Šæ¯æ ¼å¼ (Message)</h3>
                <p style="color: #a1a1aa; margin: 0.5rem 0;">åœ¨ TradingView è­¦å ±çš„ã€Œè¨Šæ¯ã€æ¬„ä½ä¸­ï¼Œä½¿ç”¨ä»¥ä¸‹ JSON æ ¼å¼ï¼ˆæ­é… Pine Script ç­–ç•¥ï¼‰ï¼š</p>
                <div class="code-block">
                    <button class="copy-btn" onclick="copyToClipboard(this, document.getElementById('payloadTemplate').textContent)">è¤‡è£½</button>
                    <pre id="payloadTemplate">{
    "action": "{{strategy.order.alert_message}}",
    "quantity": {{strategy.order.contracts}},
    "symbol": "MXFR1"
}</pre>
                </div>
                <div class="alert alert-info">
                    ğŸ’¡ <strong>èªªæ˜ï¼š</strong><code>{{strategy.order.alert_message}}</code> æœƒè‡ªå‹•å¸¶å…¥ Pine Script ä¸­è¨­å®šçš„ alert_message å€¼
                </div>
            </div>
            
            <div class="info-card">
                <h3>ğŸ“œ æ­¥é©Ÿä¸‰ï¼šPine Script ç­–ç•¥ç¯„ä¾‹</h3>
                <p style="color: #a1a1aa; margin: 0.5rem 0;">åœ¨æ‚¨çš„ Pine Script ç­–ç•¥ä¸­ï¼Œä½¿ç”¨ <code>alert_message</code> åƒæ•¸è¨­å®šäº¤æ˜“å‹•ä½œï¼š</p>
                <div class="code-block">
                    <button class="copy-btn" onclick="copyToClipboard(this, document.getElementById('pinescriptExample').textContent)">è¤‡è£½</button>
                    <pre id="pinescriptExample">//@version=5
strategy("My Strategy", overlay=true, default_qty_type=strategy.fixed, default_qty_value=1)

// ===== åƒæ•¸è¨­å®š =====
stopLossPct = input.float(2.0, "æ­¢æ %", minval=0.1, step=0.1)
takeProfitPct = input.float(4.0, "æ­¢ç›ˆ %", minval=0.1, step=0.1)

// ===== é€²å ´æ¢ä»¶ =====
fastMA = ta.sma(close, 14)
slowMA = ta.sma(close, 28)
longCondition = ta.crossover(fastMA, slowMA)
shortCondition = ta.crossunder(fastMA, slowMA)

// ===== æ­¢ææ­¢ç›ˆåƒ¹æ ¼è¨ˆç®— =====
longStopLoss = strategy.position_avg_price * (1 - stopLossPct / 100)
longTakeProfit = strategy.position_avg_price * (1 + takeProfitPct / 100)
shortStopLoss = strategy.position_avg_price * (1 + stopLossPct / 100)
shortTakeProfit = strategy.position_avg_price * (1 - takeProfitPct / 100)

// ===== åšå¤šé€²å ´ï¼ˆåŒæ™‚å¹³ç©ºå€‰ï¼‰ =====
if (longCondition)
    if (strategy.position_size < 0)  // æœ‰ç©ºå–®å…ˆå¹³å€‰
        strategy.close("Short", alert_message="short_exit")
    strategy.entry("Long", strategy.long, alert_message="long_entry")

// ===== åšç©ºé€²å ´ï¼ˆåŒæ™‚å¹³å¤šå€‰ï¼‰ =====
if (shortCondition)
    if (strategy.position_size > 0)  // æœ‰å¤šå–®å…ˆå¹³å€‰
        strategy.close("Long", alert_message="long_exit")
    strategy.entry("Short", strategy.short, alert_message="short_entry")

// ===== å¤šå–®æ­¢ææ­¢ç›ˆ =====
if (strategy.position_size > 0)
    strategy.exit("Long Exit", "Long", stop=longStopLoss, limit=longTakeProfit, alert_message="long_exit")

// ===== ç©ºå–®æ­¢ææ­¢ç›ˆ =====
if (strategy.position_size < 0)
    strategy.exit("Short Exit", "Short", stop=shortStopLoss, limit=shortTakeProfit, alert_message="short_exit")</pre>
                </div>
            </div>
            
            <div class="info-card">
                <h3>ğŸ“‹ æ¬„ä½èªªæ˜</h3>
                <div class="field-list">
                    <div class="field-item">
                        <span class="field-name">action</span>
                        <span class="field-desc">äº¤æ˜“å‹•ä½œï¼ˆä½¿ç”¨ <code>{{strategy.order.alert_message}}</code> è‡ªå‹•å¸¶å…¥ï¼‰</span>
                        <span class="badge badge-required">å¿…å¡«</span>
                    </div>
                    <div class="field-item">
                        <span class="field-name">quantity</span>
                        <span class="field-desc">äº¤æ˜“å£æ•¸ï¼ˆå¯ç”¨ <code>{{strategy.order.contracts}}</code> æˆ–å›ºå®šæ•¸å­—ï¼‰</span>
                        <span class="badge badge-required">å¿…å¡«</span>
                    </div>
                    <div class="field-item">
                        <span class="field-name">symbol</span>
                        <span class="field-desc">å•†å“ä»£ç¢¼ï¼ˆå¦‚ <code>MXFR1</code>ã€<code>MXF202601</code>ï¼‰â€” è«‹ä½¿ç”¨ã€Œå¯ç”¨å•†å“ã€é é¢çš„ Symbol æ¬„ä½å€¼</span>
                        <span class="badge badge-required">å¿…å¡«</span>
                    </div>
                </div>
                
                <h3 style="margin-top: 1.5rem;">ğŸ¯ action å¯ç”¨å€¼</h3>
                <div class="action-grid">
                    <div class="action-item">
                        <span class="action action-long_entry">long_entry</span>
                        <span class="action-desc">åšå¤šé€²å ´ - è²·å…¥é–‹å€‰</span>
                    </div>
                    <div class="action-item">
                        <span class="action action-long_exit">long_exit</span>
                        <span class="action-desc">åšå¤šå‡ºå ´ - è³£å‡ºå¹³å€‰</span>
                    </div>
                    <div class="action-item">
                        <span class="action action-short_entry">short_entry</span>
                        <span class="action-desc">åšç©ºé€²å ´ - è³£å‡ºé–‹å€‰</span>
                    </div>
                    <div class="action-item">
                        <span class="action action-short_exit">short_exit</span>
                        <span class="action-desc">åšç©ºå‡ºå ´ - è²·å…¥å¹³å€‰</span>
                    </div>
                </div>
            </div>
            
            <div class="info-card">
                <h3>ğŸ”„ TradingView å¯ç”¨ä½”ä½ç¬¦</h3>
                <p style="color: #a1a1aa; margin: 0.5rem 0 1rem;">ä»¥ä¸‹æ˜¯ TradingView è­¦å ±ä¸­å¯ä½¿ç”¨çš„è®Šæ•¸ï¼š</p>
                <div class="var-list">
                    <div class="var-item">
                        <code>{{strategy.order.alert_message}}</code>
                        <span class="var-desc">Pine Script ä¸­ alert_message åƒæ•¸çš„å€¼</span>
                    </div>
                    <div class="var-item">
                        <code>{{strategy.order.contracts}}</code>
                        <span class="var-desc">å§”è¨—çš„åˆç´„æ•¸é‡</span>
                    </div>
                    <div class="var-item">
                        <code>{{strategy.order.action}}</code>
                        <span class="var-desc">å§”è¨—å‹•ä½œï¼ˆbuy/sellï¼‰</span>
                    </div>
                    <div class="var-item">
                        <code>{{strategy.order.price}}</code>
                        <span class="var-desc">å§”è¨—åƒ¹æ ¼</span>
                    </div>
                    <div class="var-item">
                        <code>{{strategy.position_size}}</code>
                        <span class="var-desc">ç›®å‰æŒå€‰å¤§å°</span>
                    </div>
                    <div class="var-item">
                        <code>{{ticker}}</code>
                        <span class="var-desc">å•†å“ä»£ç¢¼</span>
                    </div>
                    <div class="var-item">
                        <code>{{time}}</code>
                        <span class="var-desc">è­¦å ±è§¸ç™¼æ™‚é–“</span>
                    </div>
                </div>
            </div>
            
            <div class="info-card">
                <h3>ğŸ“Œ è­¦å ±è¨Šæ¯ç¯„ä¾‹</h3>
                
                <h4 style="color: #00d9ff; margin: 1rem 0 0.5rem;">âœ¨ æ¨è–¦ï¼šæ­é… Pine Script ç­–ç•¥ä½¿ç”¨</h4>
                <p style="color: #a1a1aa; margin: 0.5rem 0;">action ç”±ç­–ç•¥è‡ªå‹•å¸¶å…¥ï¼Œquantity ä½¿ç”¨ç­–ç•¥è¨­å®šçš„å£æ•¸ï¼š</p>
                <div class="code-block">
                    <button class="copy-btn" onclick="copyToClipboard(this, this.nextElementSibling.textContent)">è¤‡è£½</button>
                    <pre>{"action": "{{strategy.order.alert_message}}", "quantity": {{strategy.order.contracts}}, "symbol": "MXFR1"}</pre>
                </div>
                
                <h4 style="color: #a1a1aa; margin: 1.5rem 0 0.5rem;">ğŸ“ æ‰‹å‹•è¨­å®šï¼šå›ºå®šå€¼</h4>
                <p style="color: #a1a1aa; margin: 0.5rem 0;">é©ç”¨æ–¼ç°¡å–®è­¦å ±æˆ–æŒ‡æ¨™è§¸ç™¼ï¼š</p>
                <div class="example-grid">
                    <div class="example-card">
                        <h4>ğŸŸ¢ å°å°åšå¤šé€²å ´ 1 å£</h4>
                        <div class="code-block">
                            <button class="copy-btn" onclick="copyToClipboard(this, this.nextElementSibling.textContent)">è¤‡è£½</button>
                            <pre>{"action": "long_entry", "quantity": 1, "symbol": "MXFR1"}</pre>
                        </div>
                    </div>
                    <div class="example-card">
                        <h4>ğŸ”µ å°å°åšå¤šå‡ºå ´</h4>
                        <div class="code-block">
                            <button class="copy-btn" onclick="copyToClipboard(this, this.nextElementSibling.textContent)">è¤‡è£½</button>
                            <pre>{"action": "long_exit", "quantity": 1, "symbol": "MXFR1"}</pre>
                        </div>
                    </div>
                    <div class="example-card">
                        <h4>ğŸ”´ å¤§å°åšç©ºé€²å ´ 2 å£</h4>
                        <div class="code-block">
                            <button class="copy-btn" onclick="copyToClipboard(this, this.nextElementSibling.textContent)">è¤‡è£½</button>
                            <pre>{"action": "short_entry", "quantity": 2, "symbol": "TXFR1"}</pre>
                        </div>
                    </div>
                    <div class="example-card">
                        <h4>ğŸŸ¡ å¤§å°åšç©ºå‡ºå ´</h4>
                        <div class="code-block">
                            <button class="copy-btn" onclick="copyToClipboard(this, this.nextElementSibling.textContent)">è¤‡è£½</button>
                            <pre>{"action": "short_exit", "quantity": 2, "symbol": "TXFR1"}</pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="info-card">
                <h3>âš ï¸ æ³¨æ„äº‹é …</h3>
                <div class="alert alert-warning">
                    <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
                        <li>é è¨­ç‚º<strong>æ¨¡æ“¬æ¨¡å¼</strong>ï¼Œå¦‚éœ€å¯¦ç›¤äº¤æ˜“è«‹åœ¨ç¶²å€åŠ ä¸Š <code>?simulation=false</code></li>
                        <li>å•†å“ä»£ç¢¼è«‹ä½¿ç”¨æ­£ç¢ºçš„æœŸè²¨ä»£ç¢¼ï¼ˆå¯åœ¨ã€Œå§”è¨—ç´€éŒ„ã€æŸ¥çœ‹æ­·å²ä½¿ç”¨çš„ä»£ç¢¼ï¼‰</li>
                        <li>ç¢ºä¿ JSON æ ¼å¼æ­£ç¢ºï¼Œæ¬„ä½åç¨±éœ€ä½¿ç”¨<strong>é›™å¼•è™Ÿ</strong></li>
                        <li>quantity å¿…é ˆç‚ºæ­£æ•´æ•¸</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/static/js/dashboard.js"></script>
</body>
</html>
